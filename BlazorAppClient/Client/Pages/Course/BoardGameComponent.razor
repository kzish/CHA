@inject State state
@inject IJSRuntime js
<div class="drag-container"></div>
<div class="board">
    @foreach (var obj in sortedObjects)
    {
        <div class="board-column todo" >
            <div class="board-column-container">
                <div class="board-column-header" title="@obj.title.Title">@obj.title.Title</div>
                <div class="board-column-content-wrapper">
                    <div class="board-column-content" id="@obj.id">
                        @foreach (var item in obj.items)
                        {
                            <div class="board-item" id="@item.Id">
                                <div class="board-item-content">
                                    <span>@item.ItemText</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>



@code {

    [Parameter]
    public BlazorAppClient.Shared.Models.MBoardGame board_game { get; set; }
    [Parameter]
    public List<BlazorAppClient.Shared.Models.MBoardGameTitles> board_game_titles { get; set; }
    [Parameter]
    public List<BlazorAppClient.Shared.Models.MBoardGameItems> board_game_items { get; set; }

    public List<BoardGameItemsOrdering> board_game_items_ordering = new List<BoardGameItemsOrdering>();

    private bool drag_initialized = false;
    private List<BoardGameAndTitles> sortedObjects = new List<BoardGameAndTitles>();

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();

        var num_titles = board_game_titles.Count;
        var num_items = board_game_items.Count;
        decimal num_for_each =  (decimal)num_items/(decimal)num_titles ;
        if (num_for_each % 1 != 0) num_for_each = (int)(num_for_each + 1);//get the extra is this has decimals

        for (int i = 0; i < num_titles; i++)
        {
            var obj = new BoardGameAndTitles()
            {
                id= board_game_titles[i].Id,
                title = board_game_titles[i],
                items = board_game_items.Skip(i * (int)num_for_each).Take((int)num_for_each).ToList()
            };
            sortedObjects.Add(obj);
        }
    }

    protected override async Task OnAfterRenderAsync(bool first_render)
    {
        if (first_render)
        {
            await js.InvokeAsync<string>("initBoardGameInstance", DotNetObjectReference.Create(this));
            //StateHasChanged();
        }
        if (!drag_initialized)
        {
            await js.InvokeAsync<string>("initDragDrop");
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        state.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        state.OnChange -= StateHasChanged;
    }

    [JSInvokable]
    public void InitGameBoardItemsOrdering(string title,List<string>items)
    {
        var board_game_item_order = new BoardGameItemsOrdering()
        {
            title_id = title,
            item_ids = items
        };
        board_game_items_ordering.Add(board_game_item_order);
        //Console.WriteLine(JsonConvert.SerializeObject(board_game_items_ordering));
        drag_initialized = true;
    }

    [JSInvokable]
    public void ReorderGameBoardItemsOrdering(string title, string item_id)
    {
        var board_game_item_order = new BoardGameItemsOrdering()
        {
            title_id = title,
            //item_ids = items
        };
        board_game_items_ordering.Add(board_game_item_order);
        //Console.WriteLine(JsonConvert.SerializeObject(board_game_items_ordering));
        drag_initialized = true;
    }

    /// <summary>
    /// this class groups the titles and items in randomized order for initialy displaying the items
    /// </summary>
    public class BoardGameAndTitles
    {
        public string id { get; set; }
        public BlazorAppClient.Shared.Models.MBoardGameTitles title { get; set; }
        public List<BlazorAppClient.Shared.Models.MBoardGameItems> items { get; set; }
    }

    //this class groups the title id and the items id when rendered and ordered by the student
    //this will be compared to the original from the server
    public class BoardGameItemsOrdering
    {
        public string title_id { get; set; }
        public List<string> item_ids { get; set; } = new List<string>();
    }
}
